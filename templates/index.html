<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiny CRM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
      /* CRM Dashboard Utility Classes */
      .crud-section {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      }
      .section-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgb(229 231 235);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: rgb(17 24 39);
        display: flex;
        align-items: center;
      }
      .section-icon {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.5rem;
      }
      .section-content {
        padding: 1.5rem;
      }
      .add-button {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        color: white;
        border-radius: 0.25rem;
        transition: opacity 0.2s;
      }
      .add-button:hover {
        opacity: 0.9;
      }
      .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid rgb(209 213 219);
        border-radius: 0.375rem;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .form-input:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        box-shadow: 0 0 0 2px currentColor;
      }
      .entity-list {
        max-height: 24rem;
        overflow-y: auto;
      }
      .entity-card {
        border: 1px solid rgb(229 231 235);
        border-radius: 0.5rem;
        padding: 1rem;
      }
      .entity-actions {
        display: flex;
        gap: 0.5rem;
        margin-left: 1rem;
      }
      .edit-button {
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
      }
      .delete-button {
        color: rgb(220 38 38);
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
      }
      .delete-button:hover {
        color: rgb(153 27 27);
      }
      .empty-state {
        text-align: center;
        padding: 2rem 0;
        color: rgb(107 114 128);
      }
      .paid-invoice {
        border-left: 4px solid rgb(34 197 94);
        background-color: rgb(240 253 244);
      }
      .unpaid-invoice {
        border-left: 4px solid rgb(239 68 68);
      }
      .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 9999px;
      }
      .status-badge-paid {
        color: rgb(22 101 52);
        background-color: rgb(220 252 231);
      }
      .status-badge-unpaid {
        color: rgb(153 27 27);
        background-color: rgb(254 226 226);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div x-data="crmDashboard()" x-init="loadAllData()">
      <!-- Form Templates -->
      <template id="crud-form-template">
        <form x-show="showForm" @submit.prevent="submitAction" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h3 class="font-medium text-gray-900 mb-4" x-text="formTitle"></h3>
          <div class="form-fields" x-html="formFields"></div>
          <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
            <button 
              type="submit"
              class="form-submit-btn px-4 py-2 text-white rounded hover:opacity-90 text-sm font-medium"
              x-text="submitButtonText"
            >
            </button>
            <button 
              type="button"
              @click="cancelAction"
              class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
            >
              Cancel
            </button>
          </div>
        </form>
      </template>

      <!-- Input Field Template -->
      <template id="input-field-template">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" x-text="label + (required ? ' *' : '')"></label>
          <input 
            :type="inputType || 'text'"
            :x-model="modelPath"
            :required="required"
            :class="inputClasses"
            :placeholder="placeholder"
            :step="step"
            :min="min"
          >
        </div>
      </template>

      <!-- Select Field Template -->
      <template id="select-field-template">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" x-text="label + ' *'"></label>
          <select 
            :x-model="modelPath"
            required
            :class="selectClasses"
          >
            <option value="" x-text="placeholder"></option>
            <template x-for="option in options" :key="option.id">
              <option :value="option.id" x-text="option.name || option.display"></option>
            </template>
          </select>
        </div>
      </template>

      <!-- Textarea Field Template -->
      <template id="textarea-field-template">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" x-text="label + (required ? ' *' : '')"></label>
          <textarea 
            :x-model="modelPath"
            :required="required"
            :rows="rows || 3"
            :class="textareaClasses"
            :placeholder="placeholder"
          ></textarea>
        </div>
      </template>
      <!-- Header -->
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <h1 class="text-2xl font-bold text-gray-900">Tiny CRM Dashboard</h1>
            <div class="flex items-center space-x-6">
              <div class="flex items-center space-x-4 text-sm text-gray-600">
              <span>
                Companies:
                <strong x-text="companies.length"></strong>
              </span>
              <span>
                Products:
                <strong x-text="products.length"></strong>
              </span>
              <span>
                Remit Info:
                <strong x-text="remitInfos.length"></strong>
              </span>
              <span>
                Invoices:
                <strong x-text="invoices.length"></strong>
              </span>
              </div>
              <button 
                @click="logout()"
                class="px-3 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                title="Logout"
              >
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                Logout
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Loading Indicator -->
      <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p class="mt-4 text-gray-700">Loading dashboard...</p>
        </div>
      </div>

      <!-- =============================================== -->
      <!-- MAIN DASHBOARD CONTENT                       -->
      <!-- =============================================== -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          
          <!-- =============================================== -->
          <!-- COMPANIES CRUD SECTION                       -->
          <!-- =============================================== -->
          <section class="crud-section">
            <div class="section-header">
              <h2 class="section-title">
                <svg class="section-icon text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                  />
                </svg>
                Companies (
                <span x-text="companies.length"></span>
                )
              </h2>
              <button 
                @click="showCompanyForm = !showCompanyForm"
                class="add-button bg-blue-600 hover:bg-blue-700"
              >
                <span x-show="!showCompanyForm">+ Add</span>
                <span x-show="showCompanyForm">Cancel</span>
              </button>
            </div>
            <div class="section-content">
              <!-- Company Create/Edit Form -->
              <form x-show="showCompanyForm" @submit.prevent="editingCompany ? updateCompany() : createCompany()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingCompany ? 'Edit Company' : 'Add New Company'"></h3>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                    <input 
                      type="text" 
                      x-model="editingCompany ? editCompany.name : newCompany.name"
                      x-ref="editCompanyName"
                      required
                      class="form-input focus:ring-blue-500"
                      placeholder="Enter company name"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Document (CNPJ) *</label>
                    <input 
                      type="text" 
                      x-model="editingCompany ? editCompany.document : newCompany.document"
                      x-ref="editCompanyDocument"
                      required
                      class="form-input focus:ring-blue-500"
                      placeholder="XX.XXX.XXX/XXXX-XX"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                    <textarea 
                      x-model="editingCompany ? editCompany.address : newCompany.address"
                      x-ref="editCompanyAddress"
                      required
                      rows="3"
                      class="form-input focus:ring-blue-500"
                      placeholder="Enter full address"
                    ></textarea>
                  </div>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium"
                    x-text="editingCompany ? 'Update Company' : 'Save Company'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingCompany ? cancelEditCompany() : resetCompanyForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="entity-list">
                <div x-show="companies.length === 0" class="empty-state">No companies found</div>
              <div x-show="companies.length > 0" class="space-y-4">
                <template x-for="company in companies" :key="company.id">
                  <div class="entity-card">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h3 class="font-medium text-gray-900" x-text="company.name || 'Unnamed Company'"></h3>
                        <p class="text-sm text-gray-600 mt-1">
                          <span class="font-medium">Document:</span>
                          <span x-text="company.document || 'N/A'"></span>
                        </p>
                        <p class="text-sm text-gray-600" x-text="company.address || 'No address'"></p>
                      </div>
                      <div class="entity-actions">
                        <button
                          @click="startEditingCompany(company)"
                          class="edit-button text-blue-600 hover:text-blue-800"
                          title="Edit Company"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteCompany(company.id)"
                          class="delete-button"
                          title="Delete Company"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>

          <!-- =============================================== -->
          <!-- PRODUCTS CRUD SECTION                        -->
          <!-- =============================================== -->
          <section class="crud-section">
            <div class="section-header">
              <h2 class="section-title">
                <svg class="section-icon text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5zM9 9a1 1 0 112 0v4a1 1 0 11-2 0V9z"
                    clip-rule="evenodd"
                  />
                </svg>
                Products (
                <span x-text="products.length"></span>
                )
              </h2>
              <button 
                @click="showProductForm = !showProductForm"
                class="add-button bg-green-600 hover:bg-green-700"
              >
                <span x-show="!showProductForm">+ Add</span>
                <span x-show="showProductForm">Cancel</span>
              </button>
            </div>
            <div class="section-content">
              <!-- Product Create/Edit Form -->
              <form x-show="showProductForm" @submit.prevent="editingProduct ? updateProduct() : createProduct()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingProduct ? 'Edit Product' : 'Add New Product'"></h3>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                    <input 
                      type="text" 
                      x-model="editingProduct ? editProduct.name : newProduct.name"
                      x-ref="editProductName"
                      required
                      class="form-input focus:ring-green-500"
                      placeholder="Enter product name"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea 
                      x-model="editingProduct ? editProduct.description : newProduct.description"
                      x-ref="editProductDesc"
                      rows="2"
                      class="form-input focus:ring-green-500"
                      placeholder="Enter product description (optional)"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Price *</label>
                    <input 
                      type="number" 
                      x-model="editingProduct ? editProduct.price : newProduct.price"
                      x-ref="editProductPrice"
                      step="0.01"
                      min="0"
                      required
                      class="form-input focus:ring-green-500"
                      placeholder="0.00"
                    >
                  </div>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium"
                    x-text="editingProduct ? 'Update Product' : 'Save Product'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingProduct ? cancelEditProduct() : resetProductForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="entity-list">
                <div x-show="products.length === 0" class="empty-state">No products found</div>
              <div x-show="products.length > 0" class="space-y-4">
                <template x-for="product in products" :key="product.id">
                  <div class="entity-card">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                          <h3 class="font-medium text-gray-900" x-text="product.name || 'Unnamed Product'"></h3>
                          <span class="text-lg font-bold text-green-600">
                            $
                            <span x-text="product.price || 0"></span>
                          </span>
                        </div>
                        <p class="text-sm text-gray-600" x-show="product.description" x-text="product.description"></p>
                      </div>
                      <div class="entity-actions">
                        <button
                          @click="startEditingProduct(product)"
                          class="edit-button text-green-600 hover:text-green-800"
                          title="Edit Product"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteProduct(product.id)"
                          class="delete-button"
                          title="Delete Product"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>

          <!-- =============================================== -->
          <!-- REMIT INFORMATION CRUD SECTION               -->
          <!-- =============================================== -->
          <section class="crud-section">
            <div class="section-header">
              <h2 class="section-title">
                <svg class="section-icon text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  />
                </svg>
                Remit Information (
                <span x-text="remitInfos.length"></span>
                )
              </h2>
              <button 
                @click="showRemitForm = !showRemitForm"
                class="add-button bg-purple-600 hover:bg-purple-700"
              >
                <span x-show="!showRemitForm">+ Add</span>
                <span x-show="showRemitForm">Cancel</span>
              </button>
            </div>
            <div class="section-content">
              <!-- Remit Information Create/Edit Form -->
              <form x-show="showRemitForm" @submit.prevent="editingRemit ? updateRemit() : createRemit()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingRemit ? 'Edit Remit Information' : 'Add New Remit Information'"></h3>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Remit Name *</label>
                    <input 
                      type="text" 
                      x-model="editingRemit ? editRemit.name : newRemit.name"
                      x-ref="editRemitName"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                      placeholder="Enter remit information name"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Information Lines *</label>
                    <template x-for="(line, index) in (editingRemit ? editRemit.lines : newRemit.lines)" :key="index">
                      <div class="flex gap-2 mb-2">
                        <input 
                          type="text" 
                          x-model="line.key"
                          required
                          class="form-input focus:ring-purple-500 flex-1"
                          placeholder="Key (e.g., Bank)"
                        >
                        <input 
                          type="text" 
                          x-model="line.value"
                          required
                          class="form-input focus:ring-purple-500 flex-1"
                          placeholder="Value (e.g., Santander)"
                        >
                        <button 
                          type="button"
                          @click="removeRemitLine(index)"
                          x-show="(editingRemit ? editRemit.lines.length : newRemit.lines.length) > 1"
                          class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                          title="Remove line"
                        >
                          ×
                        </button>
                      </div>
                    </template>
                    <button 
                      type="button"
                      @click="addRemitLine()"
                      class="px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm font-medium"
                    >
                      + Add Line
                    </button>
                  </div>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-medium"
                    x-text="editingRemit ? 'Update Remit Information' : 'Save Remit Information'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingRemit ? cancelEditRemit() : resetRemitForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="entity-list">
                <div x-show="remitInfos.length === 0" class="empty-state">
                  No remit information found
                </div>
              <div x-show="remitInfos.length > 0" class="space-y-4">
                <template x-for="remit in remitInfos" :key="remit.id">
                  <div class="entity-card">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h3 class="font-medium text-gray-900 mb-2" x-text="remit.name || 'Unnamed Remit'"></h3>
                        <template x-for="line in (remit.lines || [])" :key="line.key">
                          <p class="text-sm text-gray-600">
                            <span class="font-medium" x-text="line.key + ':'"></span>
                            <span x-text="line.value"></span>
                          </p>
                        </template>
                      </div>
                      <div class="entity-actions">
                        <button
                          @click="startEditingRemit(remit)"
                          class="edit-button text-purple-600 hover:text-purple-800"
                          title="Edit Remit Info"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteRemitInfo(remit.id)"
                          class="delete-button"
                          title="Delete Remit Info"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>

          <!-- =============================================== -->
          <!-- INVOICES CRUD SECTION                        -->
          <!-- =============================================== -->
          <section class="crud-section">
            <div class="section-header">
              <h2 class="section-title">
                <svg class="section-icon text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                    clip-rule="evenodd"
                  />
                </svg>
                Invoices (
                <span x-text="invoices.length"></span>
                )
              </h2>
              <button 
                @click="showInvoiceForm = !showInvoiceForm"
                class="add-button bg-yellow-600 hover:bg-yellow-700"
              >
                <span x-show="!showInvoiceForm">+ Add</span>
                <span x-show="showInvoiceForm">Cancel</span>
              </button>
            </div>
            <div class="section-content">
              <!-- Invoice Create/Edit Form -->
              <form x-show="showInvoiceForm" @submit.prevent="editingInvoice ? updateInvoice() : createInvoice()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingInvoice ? 'Edit Invoice' : 'Add New Invoice'"></h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                    <input 
                      type="number" 
                      x-model="editingInvoice ? editInvoice.number : newInvoice.number"
                      x-ref="editInvoiceNumber"
                      class="form-input focus:ring-yellow-500"
                      placeholder="Leave empty for auto-generation"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date *</label>
                    <input 
                      type="date" 
                      x-model="editingInvoice ? editInvoice.due_date : newInvoice.due_date"
                      x-ref="editInvoiceDueDate"
                      required
                      class="form-input focus:ring-yellow-500"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>
                    <select 
                      x-model="editingInvoice ? editInvoice.company_id : newInvoice.company_id"
                      x-ref="editInvoiceCompany"
                      required
                      class="form-input focus:ring-yellow-500"
                    >
                      <option value="">Select company...</option>
                      <template x-for="company in companies" :key="company.id">
                        <option :value="company.id" x-text="company.name"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Client *</label>
                    <select 
                      x-model="editingInvoice ? editInvoice.client_id : newInvoice.client_id"
                      x-ref="editInvoiceClient"
                      required
                      class="form-input focus:ring-yellow-500"
                    >
                      <option value="">Select client...</option>
                      <template x-for="company in companies" :key="company.id">
                        <option :value="company.id" x-text="company.name"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Remit Information *</label>
                    <select 
                      x-model="editingInvoice ? editInvoice.remit_information_id : newInvoice.remit_information_id"
                      x-ref="editInvoiceRemit"
                      required
                      class="form-input focus:ring-yellow-500"
                    >
                      <option value="">Select remit info...</option>
                      <template x-for="remit in remitInfos" :key="remit.id">
                        <option :value="remit.id" x-text="remit.name"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Discount</label>
                    <input 
                      type="number" 
                      x-model="editingInvoice ? editInvoice.discount : newInvoice.discount"
                      x-ref="editInvoiceDiscount"
                      step="0.01"
                      min="0"
                      class="form-input focus:ring-yellow-500"
                      placeholder="0.00"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Penalty</label>
                    <input 
                      type="number" 
                      x-model="editingInvoice ? editInvoice.penalty : newInvoice.penalty"
                      x-ref="editInvoicePenalty"
                      step="0.01"
                      min="0"
                      class="form-input focus:ring-yellow-500"
                      placeholder="0.00"
                    >
                  </div>
                  <div class="flex items-center mt-4">
                    <input 
                      type="checkbox" 
                      :checked="editingInvoice ? editInvoice.paid : newInvoice.paid"
                      @change="editingInvoice ? editInvoice.paid = $event.target.checked : newInvoice.paid = $event.target.checked"
                      class="w-4 h-4 text-yellow-600 bg-gray-100 border-gray-300 rounded focus:ring-yellow-500 focus:ring-2"
                      id="paid-checkbox"
                    >
                    <label for="paid-checkbox" class="ml-2 text-sm font-medium text-gray-700">
                      Paid
                    </label>
                  </div>
                </div>
                <div class="mt-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Additional Information</label>
                  <textarea 
                    x-model="editingInvoice ? editInvoice.additional_information : newInvoice.additional_information"
                    x-ref="editInvoiceAdditionalInfo"
                    rows="2"
                    class="form-input focus:ring-yellow-500"
                    placeholder="Optional additional information"
                  ></textarea>
                </div>
                <!-- Invoice Lines Section -->
                <div class="mt-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Lines *</label>
                  <template x-for="(line, index) in (editingInvoice ? editInvoice.invoice_lines : newInvoice.invoice_lines)" :key="index">
                    <div class="mb-4 border border-gray-200 rounded-lg p-3">
                      <div class="flex gap-2 mb-2">
                        <select 
                          x-model="line.product_id"
                          required
                          class="form-input focus:ring-yellow-500 flex-1"
                        >
                          <option value="">Select product...</option>
                          <template x-for="product in products" :key="product.id">
                            <option :value="product.id" x-text="product.name + ' - ' + product.price"></option>
                          </template>
                        </select>
                        <input 
                          type="number" 
                          x-model="line.quantity"
                          min="1"
                          required
                          class="form-input focus:ring-yellow-500 w-20"
                          placeholder="Qty"
                        >
                        <button 
                          type="button"
                          @click="removeInvoiceLine(index)"
                          x-show="(editingInvoice ? editInvoice.invoice_lines.length : newInvoice.invoice_lines.length) > 1"
                          class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                          title="Remove line"
                        >
                          ×
                        </button>
                      </div>
                      <!-- Description field for invoice line -->
                      <div class="mt-2">
                        <textarea 
                          x-model="line.description"
                          rows="2"
                          class="form-input focus:ring-yellow-500 w-full"
                          placeholder="Line description (optional)"
                        ></textarea>
                      </div>
                    </div>
                  </template>
                  <button 
                    type="button"
                    @click="addInvoiceLine()"
                    class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm font-medium"
                  >
                    + Add Line
                  </button>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm font-medium"
                    x-text="editingInvoice ? 'Update Invoice' : 'Save Invoice'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingInvoice ? cancelEditInvoice() : resetInvoiceForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <!-- Invoice List Display -->
              <div class="entity-list">
                <div x-show="invoices.length === 0" class="empty-state">No invoices found</div>
              <div x-show="invoices.length > 0" class="space-y-4">
                <template x-for="invoice in invoices.sort((a, b) => new Date(b.due_date) - new Date(a.due_date))" :key="invoice.id">
                  <div class="entity-card" 
                       :class="invoice.paid ? 'paid-invoice' : 'unpaid-invoice'">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                          <div class="flex items-center gap-2">
                            <h3 class="font-medium text-gray-900">
                              Invoice #
                              <span x-text="invoice.number || ''"></span>
                            </h3>
                            <!-- Paid Status Badge -->
                            <span x-show="invoice.paid" class="status-badge status-badge-paid">
                              <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                              </svg>
                              PAID
                            </span>
                            <span x-show="!invoice.paid" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">
                              <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                              </svg>
                              UNPAID
                            </span>
                          </div>
                          <div class="text-right text-sm text-gray-600">
                            <div x-show="invoice.discount > 0">
                              Discount: $
                              <span x-text="invoice.discount"></span>
                            </div>
                            <div x-show="invoice.penalty > 0">
                              Penalty: $
                              <span x-text="invoice.penalty"></span>
                            </div>
                          </div>
                        </div>
                        <p
                          class="text-sm text-gray-600"
                          x-show="invoice.additional_information"
                          x-text="invoice.additional_information"
                        ></p>
                        <p class="text-sm text-gray-500 mt-1">
                          Due:
                          <span x-text="new Date(invoice.due_date).toLocaleDateString('en-CA')"></span>
                        </p>
                        <p class="text-sm text-gray-500">
                          Company:
                          <span x-text="invoice.company?.name || 'Unknown'"></span>
                        </p>
                        <p class="text-sm text-gray-500">
                          Client:
                          <span x-text="invoice.client?.name || 'Unknown'"></span>
                        </p>
                        <!-- Invoice Lines with descriptions -->
                        <div x-show="invoice.invoice_lines && invoice.invoice_lines.length > 0" class="mt-3">
                          <h4 class="text-sm font-medium text-gray-700 mb-2">Invoice Lines:</h4>
                          <template x-for="line in invoice.invoice_lines" :key="line.id || Math.random()">
                            <div class="text-sm text-gray-600 mb-1 pl-2 border-l-2 border-gray-200">
                              <div class="flex justify-between items-start">
                                <span x-text="line.product?.name || 'Unknown Product'"></span>
                                <span class="text-xs text-gray-500">Qty: <span x-text="line.quantity"></span></span>
                              </div>
                              <p x-show="line.description && line.description.trim()" 
                                 x-text="line.description" 
                                 class="text-xs text-gray-500 mt-1 italic">
                              </p>
                            </div>
                          </template>
                        </div>
                      </div>
                      <div class="entity-actions">
                        <button
                          @click="toggleInvoicePaid(invoice)"
                          :class="invoice.paid ? 'text-red-600 hover:text-red-800' : 'text-green-600 hover:text-green-800'"
                          class="text-sm font-medium"
                          :title="invoice.paid ? 'Mark as Unpaid' : 'Mark as Paid'"
                        >
                          <span x-text="invoice.paid ? 'Mark Unpaid' : 'Mark Paid'"></span>
                        </button>
                        <button
                          @click="startEditingInvoice(invoice)"
                          class="text-yellow-600 hover:text-yellow-800 text-sm font-medium"
                          title="Edit Invoice"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteInvoice(invoice.id)"
                          class="delete-button"
                          title="Delete Invoice"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 flex items-center gap-2">
                        <select x-model="selectedTemplates[invoice.id]" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm">
                            <option value="">Select a template</option>
                            <template x-for="templ in templates">
                              <option :value="templ" x-text="templ"></option>
                            </template>
                        </select>
                        <button @click="openInvoice(invoice.id, selectedTemplates[invoice.id])" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-black text-sm font-medium">
                            Open
                        </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      function crmDashboard() {
        return {
          // =============================================
          // STATE MANAGEMENT
          // =============================================
          
          // Core Data
          loading: false,
          companies: [],
          products: [],
          remitInfos: [],
          invoices: [],
          templates: [],
          selectedTemplates: {},
          
          // UI State - Form Visibility
          showCompanyForm: false,
          showProductForm: false,
          showRemitForm: false,
          showInvoiceForm: false,
          
          // UI State - Edit Mode
          editingCompany: null,
          editingProduct: null,
          editingRemit: null,
          editingInvoice: null,
          
          // Form Data - New Entities
          newCompany: { name: '', document: '', address: '' },
          newProduct: { name: '', description: '', price: 0 },
          newRemit: { name: '', lines: [{ key: '', value: '' }] },
          newInvoice: { 
            number: null,
            additional_information: '',
            discount: 0,
            penalty: 0,
            paid: false,
            due_date: '',
            remit_information_id: null,
            company_id: null,
            client_id: null,
            invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
          },
          
          // Form Data - Edit Mode
          editCompany: { name: '', document: '', address: '' },
          editProduct: { name: '', description: '', price: 0 },
          editRemit: { name: '', lines: [{ key: '', value: '' }] },
          editInvoice: { 
            number: null,
            additional_information: '',
            discount: 0,
            penalty: 0,
            paid: false,
            due_date: '',
            remit_information_id: null,
            company_id: null,
            client_id: null,
            invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
          },

          // =============================================
          // INITIALIZATION & DATA LOADING
          // =============================================

          async loadAllData() {
            this.loading = true;
            try {
              // Load all data in parallel
              const [companiesRes, productsRes, remitRes, invoicesRes, templatesRes ] = await Promise.all([
                fetch("/api/companies"),
                fetch("/api/products"),
                fetch("/api/remit"),
                fetch("/api/invoices"),
                fetch("/api/list_invoice_templates"),
              ]);

              this.companies = companiesRes.ok ? await companiesRes.json() : [];
              this.products = productsRes.ok ? await productsRes.json() : [];
              this.remitInfos = remitRes.ok ? await remitRes.json() : [];
              this.invoices = invoicesRes.ok ? await invoicesRes.json() : [];
              this.templates = templatesRes.ok ? await templatesRes.json() : [];
            } catch (error) {
              console.error("Error loading dashboard data:", error);
            } finally {
              this.loading = false;
            }
          },

          openInvoice(invoiceId, templateName) {
            if (!templateName) {
              alert('Please select a template to open.');
              return;
            }
            window.open(`/api/invoices/${invoiceId}/open?template=${templateName}`, '_blank');
          },

          async logout() {
            try {
              await fetch('/api/logout', { method: 'POST' });
              // Redirect to root to trigger authentication prompt
              window.location.href = '/';
            } catch (error) {
              console.error('Logout error:', error);
              // Even if the request fails, redirect to trigger re-authentication
              window.location.href = '/';
            }
          },

          // =============================================
          // DELETE OPERATIONS
          // =============================================

          async deleteCompany(id) {
            if (!confirm("Are you sure you want to delete this company?")) return;
            try {
              const response = await fetch(`/api/companies/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.companies = this.companies.filter((c) => c.id !== id);
              } else {
                alert("Error deleting company");
              }
            } catch (error) {
              console.error("Error deleting company:", error);
              alert("Error deleting company: " + error.message);
            }
          },

          async deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            try {
              const response = await fetch(`/api/products/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.products = this.products.filter((p) => p.id !== id);
              } else {
                alert("Error deleting product");
              }
            } catch (error) {
              console.error("Error deleting product:", error);
              alert("Error deleting product: " + error.message);
            }
          },

          async deleteRemitInfo(id) {
            if (!confirm("Are you sure you want to delete this remit information?")) return;
            try {
              const response = await fetch(`/api/remit/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.remitInfos = this.remitInfos.filter((r) => r.id !== id);
              } else {
                alert("Error deleting remit information");
              }
            } catch (error) {
              console.error("Error deleting remit info:", error);
              alert("Error deleting remit info: " + error.message);
            }
          },

          async deleteInvoice(id) {
            if (!confirm("Are you sure you want to delete this invoice?")) return;
            try {
              const response = await fetch(`/api/invoices/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.invoices = this.invoices.filter((i) => i.id !== id);
              } else {
                alert("Error deleting invoice");
              }
            } catch (error) {
              console.error("Error deleting invoice:", error);
              alert("Error deleting invoice: " + error.message);
            }
          },

          async toggleInvoicePaid(invoice) {
            const newPaidStatus = !invoice.paid;
            const action = newPaidStatus ? 'paid' : 'unpaid';
            
            if (!confirm(`Are you sure you want to mark this invoice as ${action}?`)) return;
            
            try {
              const response = await fetch(`/api/invoices/${invoice.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  ...invoice,
                  paid: newPaidStatus
                })
              });

              if (response.ok) {
                const updatedInvoice = await response.json();
                const index = this.invoices.findIndex(i => i.id === invoice.id);
                if (index !== -1) {
                  this.invoices[index] = updatedInvoice;
                }
              } else {
                alert(`Error marking invoice as ${action}`);
              }
            } catch (error) {
              console.error(`Error toggling invoice paid status:`, error);
              alert(`Error marking invoice as ${action}: ` + error.message);
            }
          },

          // =============================================
          // FORM MANAGEMENT - RESET & SETUP
          // =============================================

          resetCompanyForm() {
            this.newCompany = { name: '', document: '', address: '' };
            this.showCompanyForm = false;
            this.editingCompany = null;
          },

          async startEditingCompany(company) {
            this.loading = true;
            
            try {
              // Fetch fresh company data from API
              const response = await fetch(`/api/companies/${company.id}`);
              if (!response.ok) {
                alert('Error fetching company details');
                return;
              }
              
              const freshCompany = await response.json();
              
              this.editingCompany = freshCompany;
              // Update properties individually to maintain Alpine.js reactivity
              this.editCompany.name = freshCompany.name;
              this.editCompany.document = freshCompany.document;
              this.editCompany.address = freshCompany.address;
              this.showCompanyForm = true;
              // Hide other forms
              this.showProductForm = false;
              this.showRemitForm = false;
              this.showInvoiceForm = false;
              
            } catch (error) {
              console.error('Error fetching company details:', error);
              alert('Error fetching company details: ' + error.message);
            } finally {
              this.loading = false;
            }
          },

          cancelEditCompany() {
            this.editingCompany = null;
            this.editCompany = { name: '', document: '', address: '' };
            this.showCompanyForm = false;
          },

          resetProductForm() {
            this.newProduct = { name: '', description: '', price: 0 };
            this.showProductForm = false;
            this.editingProduct = null;
          },

          startEditingProduct(product) {
            this.editingProduct = product;
            this.editProduct = { 
              name: product.name, 
              description: product.description || '', 
              price: product.price 
            };
            this.showProductForm = true;
            // Hide other forms
            this.showCompanyForm = false;
            this.showRemitForm = false;
            this.showInvoiceForm = false;
          },

          cancelEditProduct() {
            this.editingProduct = null;
            this.editProduct = { name: '', description: '', price: 0 };
            this.showProductForm = false;
          },

          resetRemitForm() {
            this.newRemit = { name: '', lines: [{ key: '', value: '' }] };
            this.showRemitForm = false;
            this.editingRemit = null;
          },

          async startEditingRemit(remit) {
            this.loading = true;
            
            try {
              // Fetch fresh remit data from API
              const response = await fetch(`/api/remit/${remit.id}`);
              if (!response.ok) {
                alert('Error fetching remit details');
                return;
              }
              
              const freshRemit = await response.json();
              
              this.editingRemit = freshRemit;
              // Update properties individually to maintain Alpine.js reactivity
              this.editRemit.name = freshRemit.name;
              this.editRemit.lines = freshRemit.lines && freshRemit.lines.length > 0 
                ? freshRemit.lines.map(line => ({ key: line.key, value: line.value }))
                : [{ key: '', value: '' }];
              this.showRemitForm = true;
              // Hide other forms
              this.showCompanyForm = false;
              this.showProductForm = false;
              this.showInvoiceForm = false;
              
            } catch (error) {
              console.error('Error fetching remit details:', error);
              alert('Error fetching remit details: ' + error.message);
            } finally {
              this.loading = false;
            }
          },

          cancelEditRemit() {
            this.editingRemit = null;
            this.editRemit = { name: '', lines: [{ key: '', value: '' }] };
            this.showRemitForm = false;
          },

          resetInvoiceForm() {
            this.newInvoice = { 
              number: null,
              additional_information: '',
              discount: 0,
              penalty: 0,
              paid: false,
              due_date: '',
              remit_information_id: null,
              company_id: null,
              client_id: null,
              invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
            };
            this.showInvoiceForm = false;
            this.editingInvoice = null;
          },

          async startEditingInvoice(invoice) {
            this.loading = true;
            
            try {
              // Fetch fresh invoice data from API
              const response = await fetch(`/api/invoices/${invoice.id}`);
              if (!response.ok) {
                alert('Error fetching invoice details');
                return;
              }
              
              const freshInvoice = await response.json();
              
              this.editingInvoice = freshInvoice;
              this.editInvoice = { 
                number: freshInvoice.number,
                additional_information: freshInvoice.additional_information || '',
                discount: freshInvoice.discount || 0,
                penalty: freshInvoice.penalty || 0,
                paid: freshInvoice.paid || false,
                due_date: new Date(freshInvoice.due_date).toISOString().split('T')[0], // Format for date input
                remit_information_id: freshInvoice.remit_information_id,
                company_id: freshInvoice.company_id,
                client_id: freshInvoice.client_id,
                invoice_lines: freshInvoice.invoice_lines && freshInvoice.invoice_lines.length > 0 
                  ? freshInvoice.invoice_lines.map(line => ({ 
                      product_id: line.product_id, 
                      quantity: line.quantity, 
                      description: line.description || '' 
                    }))
                  : [{ product_id: null, quantity: 1, description: '' }]
              };
              
              this.showInvoiceForm = true;
              // Hide other forms
              this.showCompanyForm = false;
              this.showProductForm = false;
              this.showRemitForm = false;
              
            } catch (error) {
              console.error('Error fetching invoice details:', error);
              alert('Error fetching invoice details: ' + error.message);
            } finally {
              this.loading = false;
            }
          },

          cancelEditInvoice() {
            this.editingInvoice = null;
            this.editInvoice = { 
              number: null,
              additional_information: '',
              discount: 0,
              penalty: 0,
              paid: false,
              due_date: '',
              remit_information_id: null,
              company_id: null,
              client_id: null,
              invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
            };
            this.showInvoiceForm = false;
          },

          // Line management for complex entities
          addRemitLine() {
            if (this.editingRemit) {
              this.editRemit.lines.push({ key: '', value: '' });
            } else {
              this.newRemit.lines.push({ key: '', value: '' });
            }
          },

          removeRemitLine(index) {
            if (this.editingRemit) {
              if (this.editRemit.lines.length > 1) {
                this.editRemit.lines.splice(index, 1);
              }
            } else {
              if (this.newRemit.lines.length > 1) {
                this.newRemit.lines.splice(index, 1);
              }
            }
          },

          addInvoiceLine() {
            if (this.editingInvoice) {
              this.editInvoice.invoice_lines.push({ product_id: null, quantity: 1, description: '' });
            } else {
              this.newInvoice.invoice_lines.push({ product_id: null, quantity: 1, description: '' });
            }
          },

          removeInvoiceLine(index) {
            if (this.editingInvoice) {
              if (this.editInvoice.invoice_lines.length > 1) {
                this.editInvoice.invoice_lines.splice(index, 1);
              }
            } else {
              if (this.newInvoice.invoice_lines.length > 1) {
                this.newInvoice.invoice_lines.splice(index, 1);
              }
            }
          },

          // =============================================
          // CREATE OPERATIONS
          // =============================================

          async createCompany() {
            if (!this.newCompany.name || !this.newCompany.document || !this.newCompany.address) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch('/api/companies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.newCompany)
              });

              if (response.ok) {
                const newCompany = await response.json();
                this.companies.push(newCompany);
                this.resetCompanyForm();
              } else {
                alert('Error creating company');
              }
            } catch (error) {
              console.error('Error creating company:', error);
              alert('Error creating company: ' + error.message);
            }
          },

          // =============================================
          // UPDATE OPERATIONS
          // =============================================

          async updateCompany() {
            // Get current values from form inputs
            const nameInput = this.$refs.editCompanyName;
            const documentInput = this.$refs.editCompanyDocument;
            const addressInput = this.$refs.editCompanyAddress;
            
            if (!nameInput || !documentInput || !addressInput) {
              console.error('Form refs not found');
              alert('Form error - please try again');
              return;
            }
            
            const formData = {
              name: nameInput.value.trim(),
              document: documentInput.value.trim(),
              address: addressInput.value.trim()
            };
            
            if (!formData.name || !formData.document || !formData.address) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch(`/api/companies/${this.editingCompany.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });

              if (response.ok) {
                const updatedCompany = await response.json();
                const index = this.companies.findIndex(c => c.id === this.editingCompany.id);
                if (index !== -1) {
                  this.companies[index] = updatedCompany;
                }
                this.cancelEditCompany();
              } else {
                alert('Error updating company');
              }
            } catch (error) {
              console.error('Error updating company:', error);
              alert('Error updating company: ' + error.message);
            }
          },

          async createProduct() {
            if (!this.newProduct.name || this.newProduct.price <= 0) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const productData = {
                name: this.newProduct.name,
                price: parseFloat(this.newProduct.price),
                description: this.newProduct.description.trim() || null
              };

              const response = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
              });

              if (response.ok) {
                const newProduct = await response.json();
                this.products.push(newProduct);
                this.resetProductForm();
              } else {
                alert('Error creating product');
              }
            } catch (error) {
              console.error('Error creating product:', error);
              alert('Error creating product: ' + error.message);
            }
          },

          async updateProduct() {
            
            // Get the current values from the form inputs
            const nameInput = this.$refs.editProductName;
            const descInput = this.$refs.editProductDesc;
            const priceInput = this.$refs.editProductPrice;
            
            
            if (!nameInput || !descInput || !priceInput) {
              console.error('Form refs not found');
              alert('Form error - please try again');
              return;
            }
            
            const formData = {
              name: nameInput.value.trim(),
              description: descInput.value.trim() || null,
              price: parseFloat(priceInput.value)
            };
            
            
            if (!formData.name || formData.price <= 0) {
              alert('Please fill in all required fields');
              return;
            }

            try {

              const response = await fetch(`/api/products/${this.editingProduct.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });

              if (response.ok) {
                const updatedProduct = await response.json();
                const index = this.products.findIndex(p => p.id === this.editingProduct.id);
                if (index !== -1) {
                  this.products[index] = updatedProduct;
                }
                this.cancelEditProduct();
              } else {
                alert('Error updating product');
              }
            } catch (error) {
              console.error('Error updating product:', error);
              alert('Error updating product: ' + error.message);
            }
          },

          async createRemit() {
            if (!this.newRemit.name || this.newRemit.lines.some(line => !line.key || !line.value)) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch('/api/remit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.newRemit)
              });

              if (response.ok) {
                const newRemit = await response.json();
                this.remitInfos.push(newRemit);
                this.resetRemitForm();
              } else {
                alert('Error creating remit information');
              }
            } catch (error) {
              console.error('Error creating remit:', error);
              alert('Error creating remit: ' + error.message);
            }
          },

          async updateRemit() {
            // Get name from form input
            const nameInput = this.$refs.editRemitName;
            
            if (!nameInput) {
              console.error('Form ref not found');
              alert('Form error - please try again');
              return;
            }
            
            const formData = {
              name: nameInput.value.trim(),
              lines: this.editRemit.lines // Keep using the bound lines array as it works
            };
            
            if (!formData.name || formData.lines.some(line => !line.key || !line.value)) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch(`/api/remit/${this.editingRemit.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });

              if (response.ok) {
                const updatedRemit = await response.json();
                const index = this.remitInfos.findIndex(r => r.id === this.editingRemit.id);
                if (index !== -1) {
                  this.remitInfos[index] = updatedRemit;
                }
                this.cancelEditRemit();
              } else {
                alert('Error updating remit information');
              }
            } catch (error) {
              console.error('Error updating remit:', error);
              alert('Error updating remit: ' + error.message);
            }
          },

          async createInvoice() {
            if (!this.newInvoice.due_date || !this.newInvoice.company_id || !this.newInvoice.client_id || !this.newInvoice.remit_information_id) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const invoiceData = {
                ...this.newInvoice,
                number: this.newInvoice.number ? parseInt(this.newInvoice.number) : null,
                discount: parseFloat(this.newInvoice.discount) || 0,
                penalty: parseFloat(this.newInvoice.penalty) || 0,
                paid: this.newInvoice.paid || false,
                due_date: new Date(this.newInvoice.due_date).toISOString(),
                remit_information_id: parseInt(this.newInvoice.remit_information_id),
                company_id: parseInt(this.newInvoice.company_id),
                client_id: parseInt(this.newInvoice.client_id),
                invoice_lines: this.newInvoice.invoice_lines.map(line => ({
                  product_id: parseInt(line.product_id),
                  quantity: parseInt(line.quantity),
                  description: line.description || null
                }))
              };

              const response = await fetch('/api/invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(invoiceData)
              });

              if (response.ok) {
                const newInvoice = await response.json();
                this.invoices.push(newInvoice);
                this.resetInvoiceForm();
              } else {
                alert('Error creating invoice');
              }
            } catch (error) {
              console.error('Error creating invoice:', error);
              alert('Error creating invoice: ' + error.message);
            }
          },

          async updateInvoice() {
            // Get current values from form inputs
            const numberInput = this.$refs.editInvoiceNumber;
            const dueDateInput = this.$refs.editInvoiceDueDate;
            const companyInput = this.$refs.editInvoiceCompany;
            const clientInput = this.$refs.editInvoiceClient;
            const remitInput = this.$refs.editInvoiceRemit;
            const discountInput = this.$refs.editInvoiceDiscount;
            const penaltyInput = this.$refs.editInvoicePenalty;
            const additionalInfoInput = this.$refs.editInvoiceAdditionalInfo;
            
            if (!numberInput || !dueDateInput || !companyInput || !clientInput || !remitInput || !discountInput || !penaltyInput || !additionalInfoInput) {
              console.error('Form refs not found');
              alert('Form error - please try again');
              return;
            }
            
            const formData = {
              number: numberInput.value ? parseInt(numberInput.value) : null,
              due_date: dueDateInput.value,
              company_id: companyInput.value,
              client_id: clientInput.value,
              remit_information_id: remitInput.value,
              discount: parseFloat(discountInput.value) || 0,
              penalty: parseFloat(penaltyInput.value) || 0,
              additional_information: additionalInfoInput.value.trim() || null,
              paid: this.editInvoice.paid || false, // Keep using bound data for paid status
              invoice_lines: this.editInvoice.invoice_lines // Keep using bound data for lines
            };
            
            if (!formData.due_date || !formData.company_id || !formData.client_id || !formData.remit_information_id) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const invoiceData = {
                ...formData,
                due_date: new Date(formData.due_date).toISOString(),
                remit_information_id: parseInt(formData.remit_information_id),
                company_id: parseInt(formData.company_id),
                client_id: parseInt(formData.client_id),
                invoice_lines: this.editInvoice.invoice_lines.map(line => ({
                  product_id: parseInt(line.product_id),
                  quantity: parseInt(line.quantity),
                  description: line.description || null
                }))
              };

              const response = await fetch(`/api/invoices/${this.editingInvoice.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(invoiceData)
              });

              if (response.ok) {
                const updatedInvoice = await response.json();
                const index = this.invoices.findIndex(i => i.id === this.editingInvoice.id);
                if (index !== -1) {
                  this.invoices[index] = updatedInvoice;
                }
                this.cancelEditInvoice();
              } else {
                alert('Error updating invoice');
              }
            } catch (error) {
              console.error('Error updating invoice:', error);
              alert('Error updating invoice: ' + error.message);
            }
          }
        };
      }
    </script>
  </body>
</html>

