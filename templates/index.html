<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiny CRM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div x-data="crmDashboard()" x-init="loadAllData()">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <h1 class="text-2xl font-bold text-gray-900">Tiny CRM Dashboard</h1>
            <div class="flex items-center space-x-4 text-sm text-gray-600">
              <span>
                Companies:
                <strong x-text="companies.length"></strong>
              </span>
              <span>
                Products:
                <strong x-text="products.length"></strong>
              </span>
              <span>
                Remit Info:
                <strong x-text="remitInfos.length"></strong>
              </span>
              <span>
                Invoices:
                <strong x-text="invoices.length"></strong>
              </span>
            </div>
          </div>
        </div>
      </header>

      <!-- Loading Indicator -->
      <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p class="mt-4 text-gray-700">Loading dashboard...</p>
        </div>
      </div>

      <!-- Main Dashboard Content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Companies Section -->
          <section class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                  />
                </svg>
                Companies (
                <span x-text="companies.length"></span>
                )
              </h2>
              <button 
                @click="showCompanyForm = !showCompanyForm"
                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                <span x-show="!showCompanyForm">+ Add</span>
                <span x-show="showCompanyForm">Cancel</span>
              </button>
            </div>
            <div class="p-6">
              <!-- Company Form -->
              <form x-show="showCompanyForm" @submit.prevent="editingCompany ? updateCompany() : createCompany()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingCompany ? 'Edit Company' : 'Add New Company'"></h3>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                    <input 
                      type="text" 
                      x-model="editingCompany ? editCompany.name : newCompany.name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Enter company name"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Document (CNPJ) *</label>
                    <input 
                      type="text" 
                      x-model="editingCompany ? editCompany.document : newCompany.document"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="XX.XXX.XXX/XXXX-XX"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                    <textarea 
                      x-model="editingCompany ? editCompany.address : newCompany.address"
                      required
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Enter full address"
                    ></textarea>
                  </div>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium"
                    x-text="editingCompany ? 'Update Company' : 'Save Company'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingCompany ? cancelEditCompany() : resetCompanyForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="max-h-96 overflow-y-auto">
                <div x-show="companies.length === 0" class="text-center py-8 text-gray-500">No companies found</div>
              <div x-show="companies.length > 0" class="space-y-4">
                <template x-for="company in companies" :key="company.id">
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h3 class="font-medium text-gray-900" x-text="company.name || 'Unnamed Company'"></h3>
                        <p class="text-sm text-gray-600 mt-1">
                          <span class="font-medium">Document:</span>
                          <span x-text="company.document || 'N/A'"></span>
                        </p>
                        <p class="text-sm text-gray-600" x-text="company.address || 'No address'"></p>
                      </div>
                      <div class="flex gap-2 ml-4">
                        <button
                          @click="startEditingCompany(company)"
                          class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                          title="Edit Company"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteCompany(company.id)"
                          class="text-red-600 hover:text-red-800 text-sm font-medium"
                          title="Delete Company"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>

          <!-- Products Section -->
          <section class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5zM9 9a1 1 0 112 0v4a1 1 0 11-2 0V9z"
                    clip-rule="evenodd"
                  />
                </svg>
                Products (
                <span x-text="products.length"></span>
                )
              </h2>
              <button 
                @click="showProductForm = !showProductForm"
                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700"
              >
                <span x-show="!showProductForm">+ Add</span>
                <span x-show="showProductForm">Cancel</span>
              </button>
            </div>
            <div class="p-6">
              <!-- Product Form -->
              <form x-show="showProductForm" @submit.prevent="editingProduct ? updateProduct() : createProduct()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingProduct ? 'Edit Product' : 'Add New Product'"></h3>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                    <input 
                      type="text" 
                      x-model="editingProduct ? editProduct.name : newProduct.name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                      placeholder="Enter product name"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea 
                      x-model="editingProduct ? editProduct.description : newProduct.description"
                      rows="2"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                      placeholder="Enter product description (optional)"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Price *</label>
                    <input 
                      type="number" 
                      x-model="editingProduct ? editProduct.price : newProduct.price"
                      step="0.01"
                      min="0"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                      placeholder="0.00"
                    >
                  </div>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium"
                    x-text="editingProduct ? 'Update Product' : 'Save Product'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingProduct ? cancelEditProduct() : resetProductForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="max-h-96 overflow-y-auto">
                <div x-show="products.length === 0" class="text-center py-8 text-gray-500">No products found</div>
              <div x-show="products.length > 0" class="space-y-4">
                <template x-for="product in products" :key="product.id">
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                          <h3 class="font-medium text-gray-900" x-text="product.name || 'Unnamed Product'"></h3>
                          <span class="text-lg font-bold text-green-600">
                            $
                            <span x-text="product.price || 0"></span>
                          </span>
                        </div>
                        <p class="text-sm text-gray-600" x-show="product.description" x-text="product.description"></p>
                      </div>
                      <div class="flex gap-2 ml-4">
                        <button
                          @click="startEditingProduct(product)"
                          class="text-green-600 hover:text-green-800 text-sm font-medium"
                          title="Edit Product"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteProduct(product.id)"
                          class="text-red-600 hover:text-red-800 text-sm font-medium"
                          title="Delete Product"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>

          <!-- Remit Information Section -->
          <section class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  />
                </svg>
                Remit Information (
                <span x-text="remitInfos.length"></span>
                )
              </h2>
              <button 
                @click="showRemitForm = !showRemitForm"
                class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700"
              >
                <span x-show="!showRemitForm">+ Add</span>
                <span x-show="showRemitForm">Cancel</span>
              </button>
            </div>
            <div class="p-6">
              <!-- Remit Information Form -->
              <form x-show="showRemitForm" @submit.prevent="editingRemit ? updateRemit() : createRemit()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingRemit ? 'Edit Remit Information' : 'Add New Remit Information'"></h3>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Remit Name *</label>
                    <input 
                      type="text" 
                      x-model="editingRemit ? editRemit.name : newRemit.name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                      placeholder="Enter remit information name"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Information Lines *</label>
                    <template x-for="(line, index) in (editingRemit ? editRemit.lines : newRemit.lines)" :key="index">
                      <div class="flex gap-2 mb-2">
                        <input 
                          type="text" 
                          x-model="line.key"
                          required
                          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                          placeholder="Key (e.g., Bank)"
                        >
                        <input 
                          type="text" 
                          x-model="line.value"
                          required
                          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                          placeholder="Value (e.g., Santander)"
                        >
                        <button 
                          type="button"
                          @click="removeRemitLine(index)"
                          x-show="(editingRemit ? editRemit.lines.length : newRemit.lines.length) > 1"
                          class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                          title="Remove line"
                        >
                          ×
                        </button>
                      </div>
                    </template>
                    <button 
                      type="button"
                      @click="addRemitLine()"
                      class="px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm font-medium"
                    >
                      + Add Line
                    </button>
                  </div>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-medium"
                    x-text="editingRemit ? 'Update Remit Information' : 'Save Remit Information'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingRemit ? cancelEditRemit() : resetRemitForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="max-h-96 overflow-y-auto">
                <div x-show="remitInfos.length === 0" class="text-center py-8 text-gray-500">
                  No remit information found
                </div>
              <div x-show="remitInfos.length > 0" class="space-y-4">
                <template x-for="remit in remitInfos" :key="remit.id">
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h3 class="font-medium text-gray-900 mb-2" x-text="remit.name || 'Unnamed Remit'"></h3>
                        <template x-for="line in (remit.lines || [])" :key="line.key">
                          <p class="text-sm text-gray-600">
                            <span class="font-medium" x-text="line.key + ':'"></span>
                            <span x-text="line.value"></span>
                          </p>
                        </template>
                      </div>
                      <div class="flex gap-2 ml-4">
                        <button
                          @click="startEditingRemit(remit)"
                          class="text-purple-600 hover:text-purple-800 text-sm font-medium"
                          title="Edit Remit Info"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteRemitInfo(remit.id)"
                          class="text-red-600 hover:text-red-800 text-sm font-medium"
                          title="Delete Remit Info"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>

          <!-- Invoices Section -->
          <section class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                    clip-rule="evenodd"
                  />
                </svg>
                Invoices (
                <span x-text="invoices.length"></span>
                )
              </h2>
              <button 
                @click="showInvoiceForm = !showInvoiceForm"
                class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700"
              >
                <span x-show="!showInvoiceForm">+ Add</span>
                <span x-show="showInvoiceForm">Cancel</span>
              </button>
            </div>
            <div class="p-6">
              <!-- Invoice Form -->
              <form x-show="showInvoiceForm" @submit.prevent="editingInvoice ? updateInvoice() : createInvoice()" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-4" x-text="editingInvoice ? 'Edit Invoice' : 'Add New Invoice'"></h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                    <input 
                      type="number" 
                      x-model="editingInvoice ? editInvoice.number : newInvoice.number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                      placeholder="Leave empty for auto-generation"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date *</label>
                    <input 
                      type="date" 
                      x-model="editingInvoice ? editInvoice.due_date : newInvoice.due_date"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>
                    <select 
                      x-model="editingInvoice ? editInvoice.company_id : newInvoice.company_id"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                    >
                      <option value="">Select company...</option>
                      <template x-for="company in companies" :key="company.id">
                        <option :value="company.id" x-text="company.name"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Client *</label>
                    <select 
                      x-model="editingInvoice ? editInvoice.client_id : newInvoice.client_id"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                    >
                      <option value="">Select client...</option>
                      <template x-for="company in companies" :key="company.id">
                        <option :value="company.id" x-text="company.name"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Remit Information *</label>
                    <select 
                      x-model="editingInvoice ? editInvoice.remit_information_id : newInvoice.remit_information_id"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                    >
                      <option value="">Select remit info...</option>
                      <template x-for="remit in remitInfos" :key="remit.id">
                        <option :value="remit.id" x-text="remit.name"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Discount</label>
                    <input 
                      type="number" 
                      x-model="editingInvoice ? editInvoice.discount : newInvoice.discount"
                      step="0.01"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                      placeholder="0.00"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Penalty</label>
                    <input 
                      type="number" 
                      x-model="editingInvoice ? editInvoice.penalty : newInvoice.penalty"
                      step="0.01"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                      placeholder="0.00"
                    >
                  </div>
                  <div class="flex items-center mt-4">
                    <input 
                      type="checkbox" 
                      :checked="editingInvoice ? editInvoice.paid : newInvoice.paid"
                      @change="editingInvoice ? editInvoice.paid = $event.target.checked : newInvoice.paid = $event.target.checked"
                      class="w-4 h-4 text-yellow-600 bg-gray-100 border-gray-300 rounded focus:ring-yellow-500 focus:ring-2"
                      id="paid-checkbox"
                    >
                    <label for="paid-checkbox" class="ml-2 text-sm font-medium text-gray-700">
                      Paid
                    </label>
                  </div>
                </div>
                <div class="mt-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Additional Information</label>
                  <textarea 
                    x-model="editingInvoice ? editInvoice.additional_information : newInvoice.additional_information"
                    rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                    placeholder="Optional additional information"
                  ></textarea>
                </div>
                <div class="mt-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Lines *</label>
                  <template x-for="(line, index) in (editingInvoice ? editInvoice.invoice_lines : newInvoice.invoice_lines)" :key="index">
                    <div class="mb-4 border border-gray-200 rounded-lg p-3">
                      <div class="flex gap-2 mb-2">
                        <select 
                          x-model="line.product_id"
                          required
                          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                        >
                          <option value="">Select product...</option>
                          <template x-for="product in products" :key="product.id">
                            <option :value="product.id" x-text="product.name + ' - ' + product.price"></option>
                          </template>
                        </select>
                        <input 
                          type="number" 
                          x-model="line.quantity"
                          min="1"
                          required
                          class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                          placeholder="Qty"
                        >
                        <button 
                          type="button"
                          @click="removeInvoiceLine(index)"
                          x-show="(editingInvoice ? editInvoice.invoice_lines.length : newInvoice.invoice_lines.length) > 1"
                          class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                          title="Remove line"
                        >
                          ×
                        </button>
                  </template>
                  <button 
                    type="button"
                    @click="addInvoiceLine()"
                    class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm font-medium"
                  >
                    + Add Line
                  </button>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                  <button 
                    type="submit"
                    class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm font-medium"
                    x-text="editingInvoice ? 'Update Invoice' : 'Save Invoice'"
                  >
                  </button>
                  <button 
                    type="button"
                    @click="editingInvoice ? cancelEditInvoice() : resetInvoiceForm()"
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
                  >
                    Cancel
                  </button>
                </div>
              </form>

              <div class="max-h-96 overflow-y-auto">
                <div x-show="invoices.length === 0" class="text-center py-8 text-gray-500">No invoices found</div>
              <div x-show="invoices.length > 0" class="space-y-4">
                <template x-for="invoice in invoices" :key="invoice.id">
                  <div class="border rounded-lg p-4" 
                       :class="invoice.paid ? 'border-l-4 border-l-green-500 border-gray-200 bg-green-50' : 'border-l-4 border-l-red-500 border-gray-200'">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                          <div class="flex items-center gap-2">
                            <h3 class="font-medium text-gray-900">
                              Invoice #
                              <span x-text="invoice.number || ''"></span>
                            </h3>
                            <!-- Paid Status Badge -->
                            <span x-show="invoice.paid" class="inline-flex items-center px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">
                              <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                              </svg>
                              PAID
                            </span>
                            <span x-show="!invoice.paid" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">
                              <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                              </svg>
                              UNPAID
                            </span>
                          </div>
                          <div class="text-right text-sm text-gray-600">
                            <div x-show="invoice.discount > 0">
                              Discount: $
                              <span x-text="invoice.discount"></span>
                            </div>
                            <div x-show="invoice.penalty > 0">
                              Penalty: $
                              <span x-text="invoice.penalty"></span>
                            </div>
                          </div>
                        </div>
                        <p
                          class="text-sm text-gray-600"
                          x-show="invoice.additional_information"
                          x-text="invoice.additional_information"
                        ></p>
                        <p class="text-sm text-gray-500 mt-1">
                          Due:
                          <span x-text="new Date(invoice.due_date).toLocaleDateString()"></span>
                        </p>
                        <p class="text-sm text-gray-500">
                          Company:
                          <span x-text="invoice.company?.name || 'Unknown'"></span>
                        </p>
                        <p class="text-sm text-gray-500">
                          Client:
                          <span x-text="invoice.client?.name || 'Unknown'"></span>
                        </p>
                      </div>
                      <div class="flex gap-2 ml-4">
                        <button
                          @click="toggleInvoicePaid(invoice)"
                          :class="invoice.paid ? 'text-red-600 hover:text-red-800' : 'text-green-600 hover:text-green-800'"
                          class="text-sm font-medium"
                          :title="invoice.paid ? 'Mark as Unpaid' : 'Mark as Paid'"
                        >
                          <span x-text="invoice.paid ? 'Mark Unpaid' : 'Mark Paid'"></span>
                        </button>
                        <button
                          @click="startEditingInvoice(invoice)"
                          class="text-yellow-600 hover:text-yellow-800 text-sm font-medium"
                          title="Edit Invoice"
                        >
                          Edit
                        </button>
                        <button
                          @click="deleteInvoice(invoice.id)"
                          class="text-red-600 hover:text-red-800 text-sm font-medium"
                          title="Delete Invoice"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 flex items-center gap-2">
                        <select x-model="selectedTemplates[invoice.id]" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm">
                            <option value="">Select a template</option>
                            <template x-for="templ in templates">
                              <option :value="templ" x-text="templ"></option>
                            </template>
                        </select>
                        <button @click="openInvoice(invoice.id, selectedTemplates[invoice.id])" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-black text-sm font-medium">
                            Open
                        </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      function crmDashboard() {
        return {
          loading: false,
          companies: [],
          products: [],
          remitInfos: [],
          invoices: [],
          templates: [],
          selectedTemplates: {},
          
          // Form visibility states
          showCompanyForm: false,
          showProductForm: false,
          showRemitForm: false,
          showInvoiceForm: false,
          
          // Edit states
          editingCompany: null,
          editingProduct: null,
          editingRemit: null,
          editingInvoice: null,
          
          // Form data
          newCompany: { name: '', document: '', address: '' },
          newProduct: { name: '', description: '', price: 0 },
          newRemit: { name: '', lines: [{ key: '', value: '' }] },
          newInvoice: { 
            number: null,
            additional_information: '',
            discount: 0,
            penalty: 0,
            paid: false,
            due_date: '',
            remit_information_id: null,
            company_id: null,
            client_id: null,
            invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
          },
          
          // Edit form data
          editCompany: { name: '', document: '', address: '' },
          editProduct: { name: '', description: '', price: 0 },
          editRemit: { name: '', lines: [{ key: '', value: '' }] },
          editInvoice: { 
            number: null,
            additional_information: '',
            discount: 0,
            penalty: 0,
            paid: false,
            due_date: '',
            remit_information_id: null,
            company_id: null,
            client_id: null,
            invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
          },

          async loadAllData() {
            this.loading = true;
            try {
              // Load all data in parallel
              const [companiesRes, productsRes, remitRes, invoicesRes, templatesRes ] = await Promise.all([
                fetch("/api/companies"),
                fetch("/api/products"),
                fetch("/api/remit"),
                fetch("/api/invoices"),
                fetch("/api/list_invoice_templates"),
              ]);

              this.companies = companiesRes.ok ? await companiesRes.json() : [];
              this.products = productsRes.ok ? await productsRes.json() : [];
              this.remitInfos = remitRes.ok ? await remitRes.json() : [];
              this.invoices = invoicesRes.ok ? await invoicesRes.json() : [];
              this.templates = templatesRes.ok ? await templatesRes.json() : [];
            } catch (error) {
              console.error("Error loading dashboard data:", error);
            } finally {
              this.loading = false;
            }
          },

          openInvoice(invoiceId, templateName) {
            if (!templateName) {
              alert('Please select a template to open.');
              return;
            }
            window.open(`/api/invoices/${invoiceId}/open?template=${templateName}`, '_blank');
          },

          async deleteCompany(id) {
            if (!confirm("Are you sure you want to delete this company?")) return;
            try {
              const response = await fetch(`/api/companies/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.companies = this.companies.filter((c) => c.id !== id);
              } else {
                alert("Error deleting company");
              }
            } catch (error) {
              console.error("Error deleting company:", error);
              alert("Error deleting company: " + error.message);
            }
          },

          async deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            try {
              const response = await fetch(`/api/products/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.products = this.products.filter((p) => p.id !== id);
              } else {
                alert("Error deleting product");
              }
            } catch (error) {
              console.error("Error deleting product:", error);
              alert("Error deleting product: " + error.message);
            }
          },

          async deleteRemitInfo(id) {
            if (!confirm("Are you sure you want to delete this remit information?")) return;
            try {
              const response = await fetch(`/api/remit/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.remitInfos = this.remitInfos.filter((r) => r.id !== id);
              } else {
                alert("Error deleting remit information");
              }
            } catch (error) {
              console.error("Error deleting remit info:", error);
              alert("Error deleting remit info: " + error.message);
            }
          },

          async deleteInvoice(id) {
            if (!confirm("Are you sure you want to delete this invoice?")) return;
            try {
              const response = await fetch(`/api/invoices/${id}`, { method: "DELETE" });
              if (response.ok) {
                this.invoices = this.invoices.filter((i) => i.id !== id);
              } else {
                alert("Error deleting invoice");
              }
            } catch (error) {
              console.error("Error deleting invoice:", error);
              alert("Error deleting invoice: " + error.message);
            }
          },

          async toggleInvoicePaid(invoice) {
            const newPaidStatus = !invoice.paid;
            const action = newPaidStatus ? 'paid' : 'unpaid';
            
            if (!confirm(`Are you sure you want to mark this invoice as ${action}?`)) return;
            
            try {
              const response = await fetch(`/api/invoices/${invoice.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  ...invoice,
                  paid: newPaidStatus
                })
              });

              if (response.ok) {
                const updatedInvoice = await response.json();
                const index = this.invoices.findIndex(i => i.id === invoice.id);
                if (index !== -1) {
                  this.invoices[index] = updatedInvoice;
                }
              } else {
                alert(`Error marking invoice as ${action}`);
              }
            } catch (error) {
              console.error(`Error toggling invoice paid status:`, error);
              alert(`Error marking invoice as ${action}: ` + error.message);
            }
          },

          // Form management methods
          resetCompanyForm() {
            this.newCompany = { name: '', document: '', address: '' };
            this.showCompanyForm = false;
            this.editingCompany = null;
          },

          startEditingCompany(company) {
            this.editingCompany = company;
            this.editCompany = { 
              name: company.name, 
              document: company.document, 
              address: company.address 
            };
            this.showCompanyForm = true;
            // Hide other forms
            this.showProductForm = false;
            this.showRemitForm = false;
            this.showInvoiceForm = false;
          },

          cancelEditCompany() {
            this.editingCompany = null;
            this.editCompany = { name: '', document: '', address: '' };
            this.showCompanyForm = false;
          },

          resetProductForm() {
            this.newProduct = { name: '', description: '', price: 0 };
            this.showProductForm = false;
            this.editingProduct = null;
          },

          startEditingProduct(product) {
            this.editingProduct = product;
            this.editProduct = { 
              name: product.name, 
              description: product.description || '', 
              price: product.price 
            };
            this.showProductForm = true;
            // Hide other forms
            this.showCompanyForm = false;
            this.showRemitForm = false;
            this.showInvoiceForm = false;
          },

          cancelEditProduct() {
            this.editingProduct = null;
            this.editProduct = { name: '', description: '', price: 0 };
            this.showProductForm = false;
          },

          resetRemitForm() {
            this.newRemit = { name: '', lines: [{ key: '', value: '' }] };
            this.showRemitForm = false;
            this.editingRemit = null;
          },

          startEditingRemit(remit) {
            this.editingRemit = remit;
            this.editRemit = { 
              name: remit.name, 
              lines: remit.lines && remit.lines.length > 0 
                ? remit.lines.map(line => ({ key: line.key, value: line.value }))
                : [{ key: '', value: '' }]
            };
            this.showRemitForm = true;
            // Hide other forms
            this.showCompanyForm = false;
            this.showProductForm = false;
            this.showInvoiceForm = false;
          },

          cancelEditRemit() {
            this.editingRemit = null;
            this.editRemit = { name: '', lines: [{ key: '', value: '' }] };
            this.showRemitForm = false;
          },

          resetInvoiceForm() {
            this.newInvoice = { 
              number: null,
              additional_information: '',
              discount: 0,
              penalty: 0,
              paid: false,
              due_date: '',
              remit_information_id: null,
              company_id: null,
              client_id: null,
              invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
            };
            this.showInvoiceForm = false;
            this.editingInvoice = null;
          },

          async startEditingInvoice(invoice) {
            this.loading = true;
            
            try {
              // Fetch fresh invoice data from API
              const response = await fetch(`/api/invoices/${invoice.id}`);
              if (!response.ok) {
                alert('Error fetching invoice details');
                return;
              }
              
              const freshInvoice = await response.json();
              
              this.editingInvoice = freshInvoice;
              this.editInvoice = { 
                number: freshInvoice.number,
                additional_information: freshInvoice.additional_information || '',
                discount: freshInvoice.discount || 0,
                penalty: freshInvoice.penalty || 0,
                paid: freshInvoice.paid || false,
                due_date: new Date(freshInvoice.due_date).toISOString().split('T')[0], // Format for date input
                remit_information_id: freshInvoice.remit_information_id,
                company_id: freshInvoice.company_id,
                client_id: freshInvoice.client_id,
                invoice_lines: freshInvoice.invoice_lines && freshInvoice.invoice_lines.length > 0 
                  ? freshInvoice.invoice_lines.map(line => ({ 
                      product_id: line.product_id, 
                      quantity: line.quantity, 
                      description: line.description || '' 
                    }))
                  : [{ product_id: null, quantity: 1, description: '' }]
              };
              
              this.showInvoiceForm = true;
              // Hide other forms
              this.showCompanyForm = false;
              this.showProductForm = false;
              this.showRemitForm = false;
              
            } catch (error) {
              console.error('Error fetching invoice details:', error);
              alert('Error fetching invoice details: ' + error.message);
            } finally {
              this.loading = false;
            }
          },

          cancelEditInvoice() {
            this.editingInvoice = null;
            this.editInvoice = { 
              number: null,
              additional_information: '',
              discount: 0,
              penalty: 0,
              paid: false,
              due_date: '',
              remit_information_id: null,
              company_id: null,
              client_id: null,
              invoice_lines: [{ product_id: null, quantity: 1, description: '' }]
            };
            this.showInvoiceForm = false;
          },

          // Line management for complex entities
          addRemitLine() {
            if (this.editingRemit) {
              this.editRemit.lines.push({ key: '', value: '' });
            } else {
              this.newRemit.lines.push({ key: '', value: '' });
            }
          },

          removeRemitLine(index) {
            if (this.editingRemit) {
              if (this.editRemit.lines.length > 1) {
                this.editRemit.lines.splice(index, 1);
              }
            } else {
              if (this.newRemit.lines.length > 1) {
                this.newRemit.lines.splice(index, 1);
              }
            }
          },

          addInvoiceLine() {
            if (this.editingInvoice) {
              this.editInvoice.invoice_lines.push({ product_id: null, quantity: 1, description: '' });
            } else {
              this.newInvoice.invoice_lines.push({ product_id: null, quantity: 1, description: '' });
            }
          },

          removeInvoiceLine(index) {
            if (this.editingInvoice) {
              if (this.editInvoice.invoice_lines.length > 1) {
                this.editInvoice.invoice_lines.splice(index, 1);
              }
            } else {
              if (this.newInvoice.invoice_lines.length > 1) {
                this.newInvoice.invoice_lines.splice(index, 1);
              }
            }
          },

          // Create methods
          async createCompany() {
            if (!this.newCompany.name || !this.newCompany.document || !this.newCompany.address) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch('/api/companies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.newCompany)
              });

              if (response.ok) {
                const newCompany = await response.json();
                this.companies.push(newCompany);
                this.resetCompanyForm();
              } else {
                alert('Error creating company');
              }
            } catch (error) {
              console.error('Error creating company:', error);
              alert('Error creating company: ' + error.message);
            }
          },

          async updateCompany() {
            if (!this.editCompany.name || !this.editCompany.document || !this.editCompany.address) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch(`/api/companies/${this.editingCompany.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.editCompany)
              });

              if (response.ok) {
                const updatedCompany = await response.json();
                const index = this.companies.findIndex(c => c.id === this.editingCompany.id);
                if (index !== -1) {
                  this.companies[index] = updatedCompany;
                }
                this.cancelEditCompany();
              } else {
                alert('Error updating company');
              }
            } catch (error) {
              console.error('Error updating company:', error);
              alert('Error updating company: ' + error.message);
            }
          },

          async createProduct() {
            if (!this.newProduct.name || this.newProduct.price <= 0) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const productData = {
                name: this.newProduct.name,
                price: parseFloat(this.newProduct.price)
              };
              
              if (this.newProduct.description.trim()) {
                productData.description = this.newProduct.description;
              }

              const response = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
              });

              if (response.ok) {
                const newProduct = await response.json();
                this.products.push(newProduct);
                this.resetProductForm();
              } else {
                alert('Error creating product');
              }
            } catch (error) {
              console.error('Error creating product:', error);
              alert('Error creating product: ' + error.message);
            }
          },

          async updateProduct() {
            if (!this.editProduct.name || this.editProduct.price <= 0) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const productData = {
                name: this.editProduct.name,
                price: parseFloat(this.editProduct.price)
              };
              
              if (this.editProduct.description.trim()) {
                productData.description = this.editProduct.description;
              }

              const response = await fetch(`/api/products/${this.editingProduct.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
              });

              if (response.ok) {
                const updatedProduct = await response.json();
                const index = this.products.findIndex(p => p.id === this.editingProduct.id);
                if (index !== -1) {
                  this.products[index] = updatedProduct;
                }
                this.cancelEditProduct();
              } else {
                alert('Error updating product');
              }
            } catch (error) {
              console.error('Error updating product:', error);
              alert('Error updating product: ' + error.message);
            }
          },

          async createRemit() {
            if (!this.newRemit.name || this.newRemit.lines.some(line => !line.key || !line.value)) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch('/api/remit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.newRemit)
              });

              if (response.ok) {
                const newRemit = await response.json();
                this.remitInfos.push(newRemit);
                this.resetRemitForm();
              } else {
                alert('Error creating remit information');
              }
            } catch (error) {
              console.error('Error creating remit:', error);
              alert('Error creating remit: ' + error.message);
            }
          },

          async updateRemit() {
            if (!this.editRemit.name || this.editRemit.lines.some(line => !line.key || !line.value)) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const response = await fetch(`/api/remit/${this.editingRemit.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.editRemit)
              });

              if (response.ok) {
                const updatedRemit = await response.json();
                const index = this.remitInfos.findIndex(r => r.id === this.editingRemit.id);
                if (index !== -1) {
                  this.remitInfos[index] = updatedRemit;
                }
                this.cancelEditRemit();
              } else {
                alert('Error updating remit information');
              }
            } catch (error) {
              console.error('Error updating remit:', error);
              alert('Error updating remit: ' + error.message);
            }
          },

          async createInvoice() {
            if (!this.newInvoice.due_date || !this.newInvoice.company_id || !this.newInvoice.client_id || !this.newInvoice.remit_information_id) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const invoiceData = {
                ...this.newInvoice,
                number: this.newInvoice.number ? parseInt(this.newInvoice.number) : null,
                discount: parseFloat(this.newInvoice.discount) || 0,
                penalty: parseFloat(this.newInvoice.penalty) || 0,
                paid: this.newInvoice.paid || false,
                due_date: new Date(this.newInvoice.due_date).toISOString(),
                remit_information_id: parseInt(this.newInvoice.remit_information_id),
                company_id: parseInt(this.newInvoice.company_id),
                client_id: parseInt(this.newInvoice.client_id),
                invoice_lines: this.newInvoice.invoice_lines.map(line => ({
                  product_id: parseInt(line.product_id),
                  quantity: parseInt(line.quantity),
                  description: line.description || null
                }))
              };

              const response = await fetch('/api/invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(invoiceData)
              });

              if (response.ok) {
                const newInvoice = await response.json();
                this.invoices.push(newInvoice);
                this.resetInvoiceForm();
              } else {
                alert('Error creating invoice');
              }
            } catch (error) {
              console.error('Error creating invoice:', error);
              alert('Error creating invoice: ' + error.message);
            }
          },

          async updateInvoice() {
            if (!this.editInvoice.due_date || !this.editInvoice.company_id || !this.editInvoice.client_id || !this.editInvoice.remit_information_id) {
              alert('Please fill in all required fields');
              return;
            }

            try {
              const invoiceData = {
                ...this.editInvoice,
                number: this.editInvoice.number ? parseInt(this.editInvoice.number) : null,
                discount: parseFloat(this.editInvoice.discount) || 0,
                penalty: parseFloat(this.editInvoice.penalty) || 0,
                paid: this.editInvoice.paid || false,
                due_date: new Date(this.editInvoice.due_date).toISOString(),
                remit_information_id: parseInt(this.editInvoice.remit_information_id),
                company_id: parseInt(this.editInvoice.company_id),
                client_id: parseInt(this.editInvoice.client_id),
                invoice_lines: this.editInvoice.invoice_lines.map(line => ({
                  product_id: parseInt(line.product_id),
                  quantity: parseInt(line.quantity),
                  description: line.description || null
                }))
              };

              const response = await fetch(`/api/invoices/${this.editingInvoice.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(invoiceData)
              });

              if (response.ok) {
                const updatedInvoice = await response.json();
                const index = this.invoices.findIndex(i => i.id === this.editingInvoice.id);
                if (index !== -1) {
                  this.invoices[index] = updatedInvoice;
                }
                this.cancelEditInvoice();
              } else {
                alert('Error updating invoice');
              }
            } catch (error) {
              console.error('Error updating invoice:', error);
              alert('Error updating invoice: ' + error.message);
            }
          }
        };
      }
    </script>
  </body>
</html>

